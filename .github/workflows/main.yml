name: CI/CD CA workflow
on:
    push:
        branches:
            - 'v[0-9]*\.[0-9]*'

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: checkout code for workflow1
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner in repo mode
              id: trivy_code_scan
              uses: aquasecurity/trivy-action@master
              with:
                scan-type: 'fs'
                ignore-unfixed: true
                format: 'table'
                output: 'trivy-results.txt'
                severity: 'HIGH'
            
            - name: Slack Notification when Code Scan Fails
              uses: rtCamp/action-slack-notify@v2
              if: steps.trivy_code_scan.outcome=='failure'
              env:  
                SLACK_WEBHOOK: ${{ secrets.TEST_SUBMISSION_WEBHOOK }}
                SLACK_MESSAGE: 'Failed trivy scan, see report for details'

            - name: Upload to slack step
              uses: adrey/slack-file-upload-action@master
              with:
                token: ${{ secrets.TOKEN }}
                path: trivy-results.txt
                channel: test-submission
            